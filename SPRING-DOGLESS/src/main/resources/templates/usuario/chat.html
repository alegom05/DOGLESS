<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Guía de Usuarios</title>
        <meta
                content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
                name="viewport"
        />
        <link
                rel="icon"
                href="/assets/img/kaiadmin/favicon.ico"
                type="image/x-icon"
        />
        <link rel="icon" href="/assets/img/kaiadmin/favicon.ico" type="image/x-icon" />
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
        <script src="/assets/js/plugin/webfont/webfont.min.js"></script>
        <script>
            WebFont.load({
                google: { families: ["Public Sans:300,400,500,600,700"] },
                custom: {
                    families: [
                        "Font Awesome 5 Solid",
                        "Font Awesome 5 Regular",
                        "Font Awesome 5 Brands",
                        "simple-line-icons",
                    ],
                    urls: ["../assets/css/fonts.min.css"],
                },
                active: function () {
                    sessionStorage.fonts = true;
                },
            });
        </script>
        <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
        <link rel="stylesheet" href="/assets/css/plugins.min.css" />
        <link rel="stylesheet" href="/assets/css/kaiadmin.min.css" />
        <link rel="stylesheet" href="/assets/js/index.js" />
        <link rel="stylesheet" href="/assets/css/demo.css" />
    </head>

    <body>
        <div class="wrapper">
            <div th:replace="~{usuario/fragments/barralateralusuario :: body(activePage='chat')}"></div>
            <div class="main-panel">
                <div th:replace="~{usuario/fragments/navbarheaderusuario :: fragment}"></div>
                <div th:replace="~{usuario/fragments/buttonChatbot :: fragment}"></div>
                <div class="container">
                    <div class="page-inner">
                        <div class="page-header">
                            <h3 class="fw-bold mb-3">Chat Pronto</h3>
                            <input name="idusuario" id="idusuario" th:value="${session.usuario.id}" type="hidden" />
                        </div>

                        <div class="container mt-5">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5>Chat Privado</h5>
                                </div>

                                <div class="card-body" id="chat-box" style="height: 400px; overflow-y: scroll; background-color: #f8f9fa;">
                                    <!-- Los mensajes se irán mostrando aquí -->
                                </div>

                                <div class="card-footer">
                                    <form id="messageForm" class="form-inline">
                                        <div class="form-group mb-2 mr-2 w-100">
                                            <input type="text" class="form-control w-50" id="receiverId" placeholder="ID del destinatario" required />
                                        </div>
                                        <div class="form-group mb-2 mr-2 w-100">
                                            <input type="text" class="form-control w-50" id="message" placeholder="Escribe un mensaje" required />
                                        </div>
                                        <button type="submit" class="btn btn-primary mb-2">Enviar</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div th:replace="~{usuario/fragments/piedepagina :: fragment}"></div>
            </div>
        </div>

        <!--   Core JS Files   -->
        <script src="/assets/js/core/jquery-3.7.1.min.js"></script>
        <script src="/assets/js/core/popper.min.js"></script>
        <script src="/assets/js/core/bootstrap.min.js"></script>
        <!-- jQuery Scrollbar -->
        <script src="/assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
        <!-- SockJS y STOMP -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
        <script type="text/javascript">
            let stompClient = null;

            function connect() {
                const socket = new SockJS('/chat-websocket');
                stompClient = Stomp.over(socket);

                stompClient.connect({}, function () {
                    stompClient.subscribe('/topic/messages/' + [[${session.usuario.id}]], function (message) {
                        showMessage(JSON.parse(message.body), false); // Para los mensajes recibidos
                    });
                });
            }

            function showMessage(message, isSentMessage) {
                const chatBox = document.getElementById('chat-box');
                const messageElement = document.createElement('div'); // Usamos un div para más flexibilidad

                // Aplicar las clases de Bootstrap dependiendo de si el mensaje fue enviado o recibido
                if (isSentMessage) {
                    messageElement.classList.add('alert', 'alert-info', 'text-end', 'mb-2'); // Estilo para mensajes enviados
                } else {
                    messageElement.classList.add('alert', 'alert-light', 'text-start', 'mb-2'); // Estilo para mensajes recibidos
                }

                // Mostrar el mensaje con un prefijo de quién lo envió
                messageElement.innerHTML = `<strong>${message.senderId}:</strong> ${message.content}`;

                // Añadir el mensaje al chat
                chatBox.appendChild(messageElement);

                // Asegurar que el chat se desplace hacia abajo automáticamente cuando se recibe un nuevo mensaje
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            document.getElementById('messageForm').onsubmit = function (e) {
                e.preventDefault();
                const receiverId = document.getElementById('receiverId').value;
                const content = document.getElementById('message').value;

                // Crear el objeto mensaje para enviarlo
                const chatMessage = {
                    senderId: [[${session.usuario.id}]],  // Usar el ID del usuario actual
                    receiverId: receiverId,
                    content: content,
                    timestamp: new Date().toISOString()
                };

                // Mostrar el mensaje enviado por el usuario
                showMessage(chatMessage, true);

                // Enviar el mensaje al servidor
                stompClient.send("/app/sendMessage", {}, JSON.stringify(chatMessage));

                // Limpiar el campo de entrada de mensaje
                document.getElementById('message').value = '';
            };

            connect();
        </script>
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@5.0.0/bundles/stomp.udm.js"></script>
    </body>
</html>

